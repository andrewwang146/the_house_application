{% extends 'bets/base.html' %}
{% load formatting %}
{% block content %}
    <div class="card">
        <h2>{{ market.title }}</h2>
        {% if market.status == 'OPEN' and can_manage %}
            <div id="settle" class="card" style="margin:.75rem 0;">
                <h3>Settle this market</h3>
                <form method="post" action="{% url 'bets:market_settle' market.pk %}">
                {% csrf_token %}
                <p>Select the winning outcome:</p>
                {% for oc in market.outcomes.all %}
                    <label style="display:block; margin:.25rem 0;">
                    <input type="radio" name="winner_id" value="{{ oc.id }}" required>
                    {{ oc.title }}
                    </label>
                {% endfor %}
                <button type="submit">Settle Market</button>
                </form>
            </div>
        {% endif %}
        {% if market.event %}<p>Event: <a href="{% url 'bets:event_detail' market.event.pk %}">{{ market.event.name }}</a></p>{% endif %}
        {% if user == market.creator or user == market.house or user.is_superuser %}
            <p><a href="{% url 'bets:market_share_invite' market.pk %}">Share this market</a></p>
        {% endif %}
        <p>
            Status: {{ market.status }}
            {% if market.closes_at %}| Closes at: {{ market.closes_at|date:"Y-m-d H:i" }}{% endif %}
            | House margin: {{ market.house_margin }}
            | House: {{ market.house|default:market.creator|default:"—" }}
            | <strong>Max bet:</strong> {{ market.max_bet_limit|money }}
        </p>
        <table class="table">
            <thead>
                <tr><th>Outcome</th><th>Odds (decimal)</th><th>Bet</th></tr>
            </thead>
            <tbody>
                {% for oc in market.outcomes.all %}
                <tr>
                    <td>{{ oc.title }}</td>
                    <td>{{ oc.decimal_odds }}</td>
                    <td>
                        {% if market.status == 'OPEN' %}
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="outcome_id" value="{{ oc.id }}" />
                            <input type="number" name="stake" min="1" step="0.01" placeholder="Stake" />
                            <button name="place_wager">Bet</button>
                        </form>
                        {% else %}
                            —
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if market.status == 'SETTLED' and can_manage %}
            <details style="margin:1rem 0;">
                <summary><strong>Settlements</strong> (click to expand)</summary>
                <p>Total staked: {{ total_staked|money }} &nbsp;|&nbsp; Paid to winners: {{ total_payout|money }} &nbsp;|&nbsp; <strong>House net:</strong> {{ house_net|money }}</p>
                <table class="table">
                <thead>
                    <tr><th>User</th><th>Outcome</th><th>Stake</th><th>Odds</th><th>Payout</th><th>Net</th></tr>
                </thead>
                <tbody>
                    {% for w in wagers %}
                    <tr>
                        <td>{{ w.user.username }}</td>
                        <td>{{ w.outcome.title }}{% if w.outcome.is_winner %} <span class="badge">Winner</span>{% endif %}</td>
                        <td>{{ w.stake|money }}</td>
                        <td>{{ w.odds_at_placement|oddsfmt }}</td>
                        {% if w.outcome.is_winner %}
                        {% with pay=w.stake|mul:w.odds_at_placement %}
                            <td>{{ pay|money }}</td>
                            <td>{{ pay|sub:w.stake|money }}</td>
                        {% endwith %}
                        {% else %}
                            <td>0.00</td>
                            <td>{{ 0|sub:w.stake|money }}</td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
                </table>
            </details>
        {% endif %}

    </div>
{% endblock %}